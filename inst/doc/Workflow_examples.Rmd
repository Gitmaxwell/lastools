---
title: "Workflow_examples"
author: "Matthew Dick & Kane Maxwell"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
    number_sections: false
    toc_depth: 5
bibliography: lastools.bib
  
vignette: >
  %\VignetteIndexEntry{Workflow_examples}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

#Introduction 

The following outlines a typical workflow for analyzing and manipulating data from a LAS file using lastools functionality, and expands on function documentation by way of example/s.


#Workflow

The typical workflow for analyzing and manipulating data from a LAS file typically comprises of:

* Compile LAS files

* Check LAS file can be read to LAS Object

* Read LAS file/s to R

* Convert/standardize LAS

* Analyse Las data

##Compile LAS files

It is common for a company to have many hundreds or thousands of LAS files across a disparate file structure. However, it may be more convenient (in order to perform analytics or for loading/writing LAS) to have LAS files stored in a single file location. 

As a first step the below examples how you might compile (copy) all ".las" files from a target directory to a nominated locaiton by creating a quick 'compile' function

```{r, echo=TRUE, eval=FALSE}
#source directory
s <- c("C:/")
# create a target directory on the file system called "compiled_las"
#target directory
t <- c("C:/compiled_las")

las_compile <-  function (s,t)
{

  list.of.files <- list.files(s, pattern = "\\.las$",recursive = TRUE, full.names = T)
  file.copy(list.of.files,t)
}

#compile las takes .las files from the source directory and moves to the target directory
las_compile(s,t)


```


## Check LAS file can be read to LAS Object

Before attempting to load a LAS file to an R las object or to a data.table it may be prudent to check that the file is 'valid'.  


**expand**


##Read LAS file/s to R

'lastools' provides two ways to load las data. The first is to load a LAS file as a LAS 'Object' (using lastools::read_las). The second is to load LAS curve data to an R data.table by using lastools::read_las_data_df. The latter is really just a wrapper for read_las, however is convenient for rapidly compiling multiple LAS data sets to a flat file structure.

Note that the majority of functions in lastools (convert, plot etc.) expect a LAS 'object', created from lastools::read_las.

Also note that the ability to compile the curve data of >10 LAS files direct to flat file format (R data.table) is a unique feature as compared to other (freely available) packages/software.  

To load a single LAS file to a LAS object is rudimentary. The function lastools::read_las simply expects a directory path to the LAS file of interest.

```{r, echo=TRUE, eval=FALSE}
lastools::read_las("filepath")
```

Note that specified NULL values in the LAS file (usually some numeric value) are set to 'NA' by default; to keep NULL values simply use 'replace_null =FALSE'.

```{r, echo=TRUE, eval=FALSE}
lastools::read_las("filepath",replace_null =FALSE)
```

Loading LAS file LOG data to data.table is also rudimentary and supports bulk loading at a directory level (no need to nominate an exact file-path to a LAS file). This function will compile all LAS log data (.las files) into a long format data table by well/file. Due to the potential variety in NULL numeric values from differing LAS files, all NULL values are set to R NA value

```{r, echo=TRUE, eval=FALSE}
lastools::read_las_data_df("directory")
```

##LAS Object

A lastools 'LAS object' is an 'R' representation of a LAS file and is returned when using the lastools::read_las function. The representation comprises of a list object with list sections  WELL, CURVE, PARAMETER and LOG are data.frames while OTHER is a string with line breaks. VERSION is a numeric (1.2 or 2.0).

Each section is representative of the most pertinent sections of a LAS file. Below is an example of each section using the example 'LAS object' data provided with lastools (accessible as lastools::example_las_obj)

###Well Section

Contains detail on the borehole (well) such as the well identifier, service company, locality details, start and stop depths etc.

```{r, echo=FALSE, results='asis',fig.width=4, fig.height=6,fig.align="center"}

library(lastools)
knitr::kable(lastools::example_las_obj$WELL,digits = 3,align = c("c"), caption = "lastools::example_las_obj$WELL")

```


###Curve section

Contains the detail (API codes and long descriptions) of the log data headings 

```{r, echo=FALSE, results='asis',fig.width=4, fig.height=6,fig.align="center"}

library(lastools)
knitr::kable(lastools::example_las_obj$CURVE,digits = 3,align = c("c"), caption = "lastools::example_las_obj$CURVE")

```

###Parameter section

Contains additional details at the discretion of the service company or the requesting company

```{r, echo=FALSE, results='asis',fig.width=4, fig.height=6,fig.align="center"}

library(lastools)
knitr::kable(lastools::example_las_obj$PARAM,digits = 3,align = c("c"), caption = "lastools::example_las_obj$PARAM")

#lastools::read_las("L:\\Coal_Quality\\R LIBRARY\\Packages\\lastools\\las_files\\PMI2279.las")

```


###Log section

Contains the actual response data in flat file (wide) format. Column names are typically codes which are fully described in the Curve section

```{r, echo=FALSE, results='asis',fig.width=4, fig.height=6,fig.align="center"}

library(lastools)
knitr::kable(head(lastools::example_las_obj$LOG, n=10),digits = 3,align = c("c"), caption = "lastools::example_las_obj$LOG")


```


##Example downloading and reading LAS File/s

###Download and read las using lastools::read_las

Example (version 2.0) LAS files can be downloaded from [Minnelusa](http://www.minnelusa.com/sampledata.php) which hosts '5,587 Well Logs' for the [Powder River Basin](https://en.wikipedia.org/wiki/Powder_River_Basin) (a geological basin covering Montana and Northeast Wyoming in the United States). The Powder River Basin is most notable for its rich coal resources (one of the largest coal deposits in the world).

Below we example downloading and unzipping some of the [sample LAS data](http://www.minnelusa.com/sample_data/LAS_Sample_API.zip) and subsequently loading the data into the R environment as a LAS Object (call it 'las1')

```{r, echo=TRUE, warning=FALSE, message=FALSE,results='hide'}

#retrive sample  las files from minnelusa
  #download zip file to a temp directory
tmpdir <- tempdir()
tmploc <- paste(tmpdir,"\\","LAS_Sample_API.zip", sep="")
download.file("http://www.minnelusa.com/sample_data/LAS_Sample_API.zip","LAS_Sample_API.zip")

#unzip file in working directory
unzip("LAS_Sample_API.zip")

#read in one of the sample las files
las1 <- lastools::read_las("49-005-30999.las")


```

Now lets take a look at the contents of the file. We will start with taking a look at the WELL section:


```{r, echo=FALSE, results='asis',fig.width=4, fig.height=6}
#inspect the WELL  component of the 
knitr::kable(las1$WELL,digits = 3,align = c("c"), caption = "las1$WELL")

```

From the header data we infer a few key details including that:

* the log was run on a depth interval (in feet) between 8660 and 8906 (total of 246 feet) and the step size (recording increment) is 1 foot.

* it was drilled in 1996 

* the well ID is (#21D-14 Rozet Minnelusa Unit)

* the well is located in Wyoming at locality SE SW 14-50N-70W

Now lets take a look at the Curve section which will tell us which types of responses have been recorded:

```{r, echo=FALSE, results='asis',fig.width=4, fig.height=6}
#inspect the WELL  component of the 
knitr::kable(las1$CURVE,digits = 3,align = c("c"), caption = "las1$CURVE")

```

We can see that Sonic Porosity (travel time - DT), Gamma Ray (GR), Deep Resistivity (RESD),  spontaneous potential (SP) have been recorded.


The visualization and analysis of this LAS data enables the specialist (usually geologist/geophysicist) to interpret/evaluate the formation for potential mineralisation and/or to determine the geophysical properties of a rock facies.

###Read downloaded las to data.table using lastools::read_las_df

Now that we have tried loading and visualizing a las file using lastool::read_las; lets try loading all the las we downloaded into a data.table using lastools::read_las_df

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='hide'}

#read all unzipped las files in working directory to a data.table
las_df <- lastools::read_las_data_df(getwd())

#setcolorder(las_df,c("well_name","DEPT","variable","Units","Descr","value","file"))

```


```{r, echo=FALSE, warning=FALSE, message=FALSE}

#obviscate file loaction column 
las_df$file <- c("file location")
#preview the data
knitr::kable(head(las_df, n=10),digits = 3,align = c("c"), caption = "Preview of imported LAS data from lastools::read_las_data_df")

```

Note that the variable column stores the curve response code while the value column stores the value for that response at the specified depth. This is a 'long format' table which differs to a 'wide' format table which is the conventional format for the LOG data section of a LAS Object and a las file. 
\pagebreak

##Visualzing/plotting data

###Plotting a LAS Object using lastools::las_plot

Now lets plot the curves up against depth in the conventional way using the default lastools::las_plot. Note that this is just a convenience function for quick visualization and since the LOG section of a las object is an R data.frame; you can create your own custom plots as you wish.

```{r, echo=FALSE, results='asis',fig.width=4, fig.height=6,fig.align="center"}
#inspect the WELL  component of the 
lastools::las_plot(las1)

```


###Plotting a LAS data.table 

Due to the (potential) initial variability of the response code names (the variables) and the number of las files which could be read using lastools::read_las_df, there is no 'out of the box' plotting functionality for this object.

However, note that the data.table is in long format convenient for plotting in packages such as ggplot2 and also useful for aggregating using the data.table package. 

Below shows an example of sub-setting the data.table to display the GR and SP of two of the wells using ggplot2. 

```{r, echo=TRUE, warning=FALSE, message=FALSE,fig.width=7, fig.height=9,fig.align="center"}

#get the names of the first two wells in the data.table
wells <-  unique(las_df$well_name)[1:2]
#subset the data.table for plotting
lassubs <- subset(las_df, las_df$variable %in% c("GR", "SP") & las_df$well_name %in% wells)
#set up the plot faceted by variable and well
lasplot <- ggplot2::ggplot(lassubs, ggplot2::aes_string(x = "value", y = "DEPT")) 
lasplot <- lasplot + ggplot2::geom_path(ggplot2::aes_string(color = "variable")) 
lasplot <- lasplot + ggplot2::scale_y_reverse() 
lasplot <- lasplot + ggplot2::facet_wrap(~well_name+variable, scale = "free_x", nrow = 1)
#plot the data
plot(lasplot)
```
  

###Tenerary plots

Example creating a tenerary plot from GR,SP,DT

```{r, echo=TRUE, warning=FALSE, message=FALSE,fig.width=5, fig.height=5,fig.align="center"}


library(ggtern)
tern <-  ggtern::ggtern(data=las1$LOG, aes(GR,SP,DT)) + geom_point()
plot(tern)

```


###Clustering Analysis

```{r, echo=TRUE, warning=FALSE, message=FALSE,fig.width=10, fig.height=5,fig.align="center"}

  #add noramilsed data
normalise <- function(x) {(x-min(x, na.rm = T))/(max(x,na.rm = T)-min(x,na.rm = T))}
las_df <- as.data.table(las_df)
las_df[,`:=`(normvalue =normalise(value)),by=.(variable)]
las_df_dc <- dcast(las_df, well_name+DEPT~variable, value.var = "normvalue")

#bend in plot at 7-8 clusters

library(cluster)

set.seed(4)
#k - means - efacies
kfit <- pam(las_df_dc[,c("GR","SP","DT","RESD")], 6)
#plot(las_df_dc[,c("GR","SP","DT")],col = kfit$cluster)
#append cluster to data
las_df_dc$clust <- kfit$cluster
#normalise cluster values so we plot nicely
las_df_dc$clust <- normalise(kfit$cluster)


las_df_melt <- melt(las_df_dc, id.vars = c("well_name","DEPT"))
setorderv(las_df_melt, c("well_name", "DEPT", "variable"))


lasplot2 <- ggplot2::ggplot(subset(las_df_melt,las_df_melt$well_name ==c("#13-31 Hoffman Et Al")), ggplot2::aes_string(x = "value", y = "DEPT")) 
lasplot2 <- lasplot2 + ggplot2::geom_path(ggplot2::aes_string(color = "value")) 
lasplot2 <- lasplot2 + ggplot2::scale_y_reverse() 
lasplot2 <- lasplot2 + ggplot2::facet_wrap(~variable, scale = "free_x", nrow = 1)
#lasplot2 <- lasplot2 + ggplot2::facet_wrap(~variable, nrow = 1)
lasplot2 <- lasplot2 + scale_colour_gradientn(colours = terrain.colors(10))
#plot the data
plot(lasplot2)


ggplot(data=subset(las_df_melt,las_df_melt$well_name ==c("#13-31 Hoffman Et Al")), aes(x=DEPT, y=value, colour=variable)) + geom_line() 

library(ggtern)
#tern <-  ggtern::ggtern(data=las_df_dc, aes(GR,SP,DT, colour=clust)) + geom_point() 
tern <-  ggtern::ggtern(data=las_df_dc, aes(GR,SP,DT)) + geom_point() 
#+ scale_colour_gradientn(colours = primary.colors(5))
# + scale_colour_gradientn(colours = terrain.colors(10))
plot(tern)


#library(cluster)
#data(xclara)
#km <- kmeans(xclara[1:100,],3)
#dissE <- daisy(xclara[1:100,])
#sk <- silhouette(km$cl, dissE)
#plot(sk)

```
###SOM Analysis

```{r, echo=TRUE, warning=FALSE, message=FALSE,fig.width=10, fig.height=5,fig.align="center"}

install.packages("kohonen")

library(kohonen)

#https://www.r-bloggers.com/self-organising-maps-for-customer-segmentation-using-r/
  
#add noramilsed data
normalise <- function(x) {(x-min(x, na.rm = T))/(max(x,na.rm = T)-min(x,na.rm = T))}
las_df <- as.data.table(las_df)
las_df[,`:=`(normvalue =normalise(value)),by=.(variable)]
las_df_dc <- dcast(las_df, well_name+DEPT~variable, value.var = "normvalue")

#bend in plot at 7-8 clusters

library(cluster)

set.seed(4)
#k - means - efacies
kfit <- pam(las_df_dc[,c("GR","SP","DT","RESD")], 6)
#plot(las_df_dc[,c("GR","SP","DT")],col = kfit$cluster)
#append cluster to data
las_df_dc$clust <- kfit$cluster
#normalise cluster values so we plot nicely
las_df_dc$clust <- normalise(kfit$cluster)


las_df_melt <- melt(las_df_dc, id.vars = c("well_name","DEPT"))
setorderv(las_df_melt, c("well_name", "DEPT", "variable"))


lasplot2 <- ggplot2::ggplot(subset(las_df_melt,las_df_melt$well_name ==c("#13-31 Hoffman Et Al")), ggplot2::aes_string(x = "value", y = "DEPT")) 
lasplot2 <- lasplot2 + ggplot2::geom_path(ggplot2::aes_string(color = "value")) 
lasplot2 <- lasplot2 + ggplot2::scale_y_reverse() 
lasplot2 <- lasplot2 + ggplot2::facet_wrap(~variable, scale = "free_x", nrow = 1)
#lasplot2 <- lasplot2 + ggplot2::facet_wrap(~variable, nrow = 1)
lasplot2 <- lasplot2 + scale_colour_gradientn(colours = terrain.colors(10))
#plot the data
plot(lasplot2)


ggplot(data=subset(las_df_melt,las_df_melt$well_name ==c("#13-31 Hoffman Et Al")), aes(x=DEPT, y=value, colour=variable)) + geom_line() 

library(ggtern)
#tern <-  ggtern::ggtern(data=las_df_dc, aes(GR,SP,DT, colour=clust)) + geom_point() 
tern <-  ggtern::ggtern(data=las_df_dc, aes(GR,SP,DT)) + geom_point() 
#+ scale_colour_gradientn(colours = primary.colors(5))
# + scale_colour_gradientn(colours = terrain.colors(10))
plot(tern)


#library(cluster)
#data(xclara)
#km <- kmeans(xclara[1:100,],3)
#dissE <- daisy(xclara[1:100,])
#sk <- silhouette(km$cl, dissE)
#plot(sk)

```
  
#References


